<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Undertale</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#0c0c0c;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0; }
    .card { background:#111;border-radius:12px;padding:20px;max-width:720px;border:2px solid #8B0000; box-shadow:0 0 24px rgba(139,0,0,0.25); }
    pre { background: rgba(255,255,255,0.03); padding:8px;border-radius:6px; overflow:auto; max-height:200px; }
    button { margin-top:12px; padding:8px 12px; border-radius:8px;border:0;background:#8B0000;color:#fff;cursor:pointer;font-weight:600 }
  </style>
</head>
<body>
  <div class="card" role="main" aria-live="polite">
    <h2>Undertale Launcher</h2>
    <p>Undertale Fixed Up By Jon Stearns</p>
    <div id="log"><strong>Status:</strong> <span id="status">idle</span></div>
    <pre id="messages"></pre>
    <button id="startBtn">Pirate Game</button>
    <p style="margin-top:10px;color:#ccc;font-size:.9em">
      Thid Works By Feching Files From My Alt Github Account, GX-Storage And Then Running Them Via Https 
    </p>
  </div>

  <script>
  (function () {
    const parts = [
      'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part1',
      'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part2',
      'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part3',
      'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part4',
      'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part5',
      'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part6',
      'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part7'
    ];

    const localFiles = ['runner.wasm', 'runner.data', 'runner.js', 'index.js']; // will load from same folder as HTML
    const statusEl = document.getElementById('status');
    const msgEl = document.getElementById('messages');
    const log = (t)=>{ msgEl.textContent += t + "\n"; msgEl.scrollTop = msgEl.scrollHeight; };
    const setStatus = s => { if(statusEl) statusEl.textContent = s; };

    async function fetchArrayBufferSafe(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error(path + ' â†’ HTTP ' + res.status);
        return await res.arrayBuffer();
      } catch (e) {
        throw new Error('Failed to fetch ' + path + ': ' + e.message);
      }
    }

    async function combineParts() {
      setStatus('fetching parts');
      log('Fetching parts (in order)...');
      const buffers = [];
      let total = 0;
      for (const p of parts) {
        try {
          const buf = await fetchArrayBufferSafe(p);
          buffers.push(buf);
          total += buf.byteLength;
          log('  - fetched ' + p.split('/').pop() + ' (' + Math.round(buf.byteLength/1024) + ' KB)');
        } catch (e) {
          log('  - WARN: ' + e.message);
        }
      }
      if (buffers.length === 0) throw new Error('No part files were fetched.');
      setStatus('combining parts');
      const combined = new Uint8Array(total);
      let offset = 0;
      for (const b of buffers) { combined.set(new Uint8Array(b), offset); offset += b.byteLength; }
      log('Combined size: ' + Math.round(combined.byteLength/1024) + ' KB');
      return combined.buffer;
    }

    async function injectLocalScripts() {
      setStatus('loading scripts');
      log('Injecting local runner.js and index.js...');
      for (const f of ['runner.js','index.js']) {
        const s = document.createElement('script');
        s.src = f;
        s.async = false;
        s.onload = () => log('Loaded ' + f);
        s.onerror = () => log('Failed to load ' + f);
        document.head.appendChild(s);
      }
    }

    async function start() {
      try {
        setStatus('starting');
        log('Checking local files...');
        for (const f of localFiles) {
          const ok = await fetch(f, {method:'HEAD'}).then(r=>r.ok).catch(()=>false);
          if (!ok) log('  - NOTE: ' + f + ' not found locally.');
        }
        const combinedBuf = await combineParts();
        // Provide the combined game.unx via a blob to override fetch
        const gameBlob = new Blob([combinedBuf]);
        const gameUrl = URL.createObjectURL(gameBlob);
        const originalFetch = window.fetch;
        window.fetch = async function (input, options) {
          if ((typeof input === 'string' && input.includes('game.unx')) ||
              (input instanceof Request && input.url.includes('game.unx'))) {
            return originalFetch.call(this, gameUrl, options);
          }
          return originalFetch.call(this, input, options);
        };
        await injectLocalScripts();
        setStatus('done - game should boot');
        log('Game starting...');
      } catch (err) {
        setStatus('error');
        log('ERROR: ' + err.message);
      }
    }

    document.getElementById('startBtn').addEventListener('click', async () => {
      document.getElementById('startBtn').disabled = true;
      setStatus('preparing');
      await start();
    });
  })();
  </script>
</body>
</html>
