<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Undertale Launcher</title>
<style>
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background:#0c0c0c;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    height:100vh;
    margin:0;
  }
  .card {
    background:#111;
    border-radius:12px;
    padding:30px;
    max-width:900px;
    width:90%;
    border:2px solid #8B0000;
    box-shadow:0 0 24px rgba(139,0,0,0.25);
    text-align:center;
  }
  pre {
    background: rgba(255,255,255,0.03);
    padding:8px;
    border-radius:6px;
    overflow:auto;
    max-height:200px;
    text-align:left;
  }
  #status { font-weight:bold; color:#bdff00; }
</style>
</head>
<body>
<div class="card">
  <h2>Undertale Launcher</h2>
  <p>Ripped by Jon Stearns</p>
  <div id="log"><strong>Status:</strong> <span id="status">idle</span></div>
  <pre id="messages"></pre>
</div>

<script>
(async function() {
  const parts = [
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part1',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part2',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part3',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part4',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part5',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part6',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part7'
  ];

  const localScripts = ['runner.data', 'runner.wasm', 'runner.js', 'index.js'];
  const statusEl = document.getElementById('status');
  const msgEl = document.getElementById('messages');

  function log(text) {
    msgEl.textContent += text + '\n';
    msgEl.scrollTop = msgEl.scrollHeight;
  }

  function setStatus(text) {
    if(statusEl) statusEl.textContent = text;
  }

  async function fetchArrayBufferSafe(url) {
    setStatus('Fetching ' + url.split('/').pop());
    log('Fetching: ' + url.split('/').pop());
    const res = await fetch(url);
    if(!res.ok) throw new Error(url + ' â†’ HTTP ' + res.status);
    return await res.arrayBuffer();
  }

  async function loadGameUnx() {
    setStatus('Fetching game parts...');
    log('Fetching parts in order...');
    const buffers = [];
    let total = 0;
    for(const url of parts){
      const buf = await fetchArrayBufferSafe(url);
      buffers.push(buf);
      total += buf.byteLength;
      log('  - fetched ' + url.split('/').pop() + ' (' + Math.round(buf.byteLength/1024) + ' KB)');
    }
    const combined = new Uint8Array(total);
    let offset = 0;
    for(const b of buffers){ combined.set(new Uint8Array(b), offset); offset += b.byteLength; }
    log('Combined size: ' + Math.round(combined.byteLength/1024) + ' KB');
    return new Blob([combined]);
  }

  async function injectLocalScripts() {
    setStatus('Loading local scripts...');
    for(const f of localScripts){
      log('Injecting ' + f);
      const s = document.createElement('script');
      s.src = f;
      s.async = false;
      document.body.appendChild(s);
    }
  }

  try {
    const gameBlob = await loadGameUnx();
    const gameUrl = URL.createObjectURL(gameBlob);

    // Override fetch for game.unx
    const originalFetch = window.fetch;
    window.fetch = async function(input, options) {
      if((typeof input === 'string' && input.includes('game.unx')) ||
         (input instanceof Request && input.url.includes('game.unx'))){
        return originalFetch.call(this, gameUrl, options);
      }
      return originalFetch.call(this, input, options);
    };

    await injectLocalScripts();
    setStatus('Game should boot now...');
    log('Game starting...');
  } catch(e) {
    setStatus('Error');
    log('ERROR: ' + e.message);
  }
})();
</script>
</body>
</html>
