<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Undertale</title>
<style>
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background:#0c0c0c;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    height:100vh;
    margin:0;
  }
  .card {
    background:#111;
    border-radius:12px;
    padding:30px;
    max-width:900px;
    width:90%;
    border:2px solid #8B0000;
    box-shadow:0 0 24px rgba(139,0,0,0.25);
    text-align:center;
  }
  pre {
    background: rgba(255,255,255,0.03);
    padding:8px;
    border-radius:6px;
    overflow:auto;
    max-height:200px;
    text-align:left;
  }
  #status { font-weight:bold; color:#bdff00; }
</style>
</head>
<body>
<div class="card">
  <h2>Undertale Launcher</h2>
  <p>Ripped by Jon Stearns</p>
  <div id="log"><strong>Status:</strong> <span id="status">idle</span></div>
  <pre id="messages"></pre>
</div>

<script>
(async function(){
  const partsFolder = 'game-files';
  const parts = [
    'game.unx.part1',
    'game.unx.part2',
    'game.unx.part3',
    'game.unx.part4',
    'game.unx.part5',
    'game.unx.part6',
    'game.unx.part7'
  ].map(f => `${partsFolder}/${f}`);

  const localFiles = ['runner.wasm','runner.data','runner.js','index.js'];
  const statusEl = document.getElementById('status');
  const msgEl = document.getElementById('messages');
  const log = t => { msgEl.textContent += t + "\n"; msgEl.scrollTop = msgEl.scrollHeight; };
  const setStatus = s => { if(statusEl) statusEl.textContent = s; };

  async function fetchArrayBufferSafe(path){
    setStatus('Loading ' + path.split('/').pop());
    log('Fetching ' + path.split('/').pop() + '...');
    const res = await fetch(path);
    if(!res.ok) throw new Error(path + ' â†’ HTTP ' + res.status);
    const buf = await res.arrayBuffer();
    log('Fetched ' + path.split('/').pop() + ' (' + Math.round(buf.byteLength/1024) + ' KB)');
    return buf;
  }

  async function combineParts(){
    setStatus('Combining parts');
    log('Combining parts...');
    const buffers = [];
    let total = 0;
    for(const p of parts){
      const buf = await fetchArrayBufferSafe(p);
      buffers.push(buf);
      total += buf.byteLength;
    }
    const combined = new Uint8Array(total);
    let offset=0;
    for(const b of buffers){ combined.set(new Uint8Array(b), offset); offset+=b.byteLength; }
    log('Combined size: ' + Math.round(combined.byteLength/1024) + ' KB');
    return combined.buffer;
  }

  async function injectLocalScripts(){
    setStatus('Loading scripts');
    log('Injecting runner.js and index.js...');
    for(const f of ['runner.js','index.js']){
      await new Promise((res,rej)=>{
        const s = document.createElement('script');
        s.src = f;
        s.onload = ()=> { log('Loaded ' + f); res(); };
        s.onerror = ()=> { log('Failed to load ' + f); rej(); };
        document.head.appendChild(s);
      });
    }
  }

  try{
    setStatus('Starting launcher');
    log('Checking local files...');
    for(const f of localFiles){
      const ok = await fetch(f,{method:'HEAD'}).then(r=>r.ok).catch(()=>false);
      if(!ok) log('  - NOTE: ' + f + ' not found locally.');
    }
    const combinedBuf = await combineParts();
    // Provide the combined game.unx via blob to override fetch
    const gameBlob = new Blob([combinedBuf]);
    const gameUrl = URL.createObjectURL(gameBlob);
    const originalFetch = window.fetch;
    window.fetch = async function(input,options){
      if((typeof input==='string' && input.includes('game.unx')) ||
         (input instanceof Request && input.url.includes('game.unx'))){
           return originalFetch.call(this, gameUrl, options);
      }
      return originalFetch.call(this,input,options);
    };
    await injectLocalScripts();
    setStatus('Game should boot now');
    log('Game starting...');
  }catch(err){
    setStatus('error');
    log('ERROR: '+err.message);
  }
})();
</script>
</body>
</html>
