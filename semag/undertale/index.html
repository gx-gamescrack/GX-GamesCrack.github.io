<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Undertale</title>
<style>
body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background:#0c0c0c;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  margin:0;
}
.card {
  background:#111;
  border-radius:12px;
  padding:20px;
  width:900px;
  border:2px solid #8B0000;
  box-shadow:0 0 24px rgba(139,0,0,0.25);
}
pre {
  background: rgba(255,255,255,0.03);
  padding:8px;
  border-radius:6px;
  overflow:auto;
  max-height:200px;
}
</style>
</head>
<body>
<div class="card">
  <h2>Undertale Launcher</h2>
  <p>Ripped by Jon Stearns</p>
  <div><strong>Status:</strong> <span id="status">idle</span></div>
  <pre id="messages"></pre>
</div>

<script>
(async function() {
  const parts = [
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part1',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part2',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part3',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part4',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part5',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part6',
    'https://cdn.jsdelivr.net/gh/GX-Storage/GX-Storage@main/undertale/game.unx.part7'
  ];

  const statusEl = document.getElementById('status');
  const msgEl = document.getElementById('messages');
  const log = t => { msgEl.textContent += t + "\n"; msgEl.scrollTop = msgEl.scrollHeight; };
  const setStatus = s => { if(statusEl) statusEl.textContent = s; };

  async function fetchPart(url) {
    setStatus('Fetching ' + url.split('/').pop());
    log('Fetching ' + url.split('/').pop());
    const res = await fetch(url);
    if(!res.ok) throw new Error('Failed: ' + url);
    return await res.arrayBuffer();
  }

  async function combineParts() {
    const buffers = [];
    for(const p of parts) buffers.push(await fetchPart(p));
    setStatus('Combining parts');
    const totalLength = buffers.reduce((sum,b)=>sum+b.byteLength,0);
    const combined = new Uint8Array(totalLength);
    let offset = 0;
    for(const b of buffers) { combined.set(new Uint8Array(b), offset); offset+=b.byteLength; }
    log('Combined size: ' + Math.round(totalLength/1024) + ' KB');
    return combined.buffer;
  }

  async function loadGame() {
    setStatus('Preparing game');
    const combinedBuffer = await combineParts();
    const gameBlob = new Blob([combinedBuffer]);
    const gameUrl = URL.createObjectURL(gameBlob);

    // Override fetch for game.unx
    const originalFetch = window.fetch;
    window.fetch = async function(input, opts) {
      if((typeof input==='string' && input.includes('game.unx')) ||
         (input instanceof Request && input.url.includes('game.unx'))) {
        return originalFetch.call(this, gameUrl, opts);
      }
      return originalFetch.call(this,input,opts);
    };

    // Load local runner.js and index.js
    for(const f of ['runner.js','index.js']) {
      await new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src=f; s.async=false;
        s.onload=resolve; s.onerror=()=>reject('Failed to load '+f);
        document.body.appendChild(s);
      });
    }

    setStatus('Game starting...');
    log('Game starting...');
  }

  // Auto-start
  try { await loadGame(); } catch(e) { setStatus('Error'); log(e.message); }
})();
</script>
</body>
</html>
